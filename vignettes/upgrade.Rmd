---
title: "Upgrade Guide"
author: "Pedro J. Aphalo"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Upgrade Guide}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

## What is new in versions >= 0.6.0 of package `photobiology`

I have renamed classes and functions as I have learnt in the hard way that using
dots is S3 class names and methods causes lots of problems. The name changes will break
old code and stored/saved spectral objects need to be __upgraded__ before 
they can be used with the new version of the suite. Of course, they continue
to be valid `data.table` and `data.frame` objects.

Several frequently used classes like `data.frame` and `data.table` include a
dot in their name, but as Hadley Wickham emphasizes in his book _R packages_
it is much better to consistently use underscores instead of dots.

The naming rules I am now following are:

Class names include only letters, or letter plus underscore characters, leading
to these name changes:

- `generic.spct` $\to$ `generic_spct`
- `source.spct` $\to$ `source_spct`
- `response.spct` $\to$ `response_spct`
- `filter.spct` $\to$ `filter_spct`
- `reflector.spct` $\to$ `reflector_spct`
- `object.spct` $\to$ `object_spct`
- `chroma.spct` $\to$ `chroma_spct`

Constructors have been renamed accordingly:

- `generic.spct()` $\to$ `generic_spct()`
- `source.spct()` $\to$ `source_spct()`
- _etc._

The class-test and copy-and-set class functions were renamed to match, but
following 'normal' R style the first dot has been maintained:

- `is.source.spct()` $\to$ `is.source_spct()`
- `as.source.spct()` $\to$ `as.source_spct()`
- `is.any.spct()` $\to$ `is.any_spct()`
- _etc._
    
With exception of `is.  ()` and `as.  ()` functions shown
above, all function names no longer contain dots. In the new names dots have
been replaced by underscores. This also affected those `is.  ()` functions
which are not S3 methods and which are used to query other attributes or 
properties of spectral objects.

- `is.effective()` $\to$ `is_effective()`
- `is.normalized()` $\to$ `is_normalized()`
- `is.rescaled()` $\to$ `is_scaled()`
- _etc._
   
BSWF-waveband creation functions were also renamed to achieve consistency:

- `GEN.G()` $\to$ `GEN_G()`
- `DNA.N()` $\to$ `DNA_N()`
- _etc._

In the case of functions used to automate the creation of BSWF-based wavebands
the old names are no longer indexed
in the documentation, but the functions themselves will remain available. 
However, __in new scripts the new names should be used__, as they are _deprecated_ 
and may be no longer available in future versions of the suite.

There is one further name change, required by conflicting names with other
existing R functions: `Rescale()` $\to$ `fscale()`, the `f` coming 
from function, as rescaling is done based on a summary function supplied
through formal parameter `f`.

## How to check if an R object is a `generic.spct` (versions >= 0.6.1)

Function `is.old_spct` can be used to query if an R object is a spectral
object created with a version of package `photobiology` with version
< 0.6.0.

We need to only consider `generic.spct` as objects of derived classes
like `source.spct` are by inheritance also `generic.spct` objects.

## How to upgrade your old scripts to work with the new version (versions >= 0.6.1)

To upgrade the spectral objects what needs to be done is to change the
names stored in the `class` attribute of spectral objects, as only the
name of the class has changed rather than its definition.

In the new version we still export the S3 class `generic.spct` (with a dot)
so that old spectral objects can be _recognized_ and the upgrade method
applied.

We have also defined a method of function `upgrade()` for
single `generic.spct` objects. So all what is needed is to call upgrade, 
with the object to be upgraded as argument. The _upgrade_ is done by 
reference (in place) in the object supplied as argument.

To demonstrate this we _fake_ an spectral object defined by and earlier
version of the package by changing the class attribute.

```{r}
library(photobiology)
my.old.spct <- source_spct(w.length = 400:450, s.e.irrad = 1)
class(my.old.spct) <-  gsub("_spct", ".spct", class(my.old.spct), fixed = TRUE)
class(my.old.spct)
another.old.spct <- copy(my.old.spct)
```

We can use method `upgrade()` to upgrade a single spectrum.

```{r}
is.old_spct(my.old.spct)
upgrade(my.old.spct)
is.old_spct(my.old.spct)
is.source_spct(my.old.spct)
```

Another function `upgrade_spectra` takes as argument a list of R objects.
Objects which are not _old spectra_ are not altered, while _old spectra_
are upgraded. The default is to upgrade all objects in the current environment
and enclosing environments.

```{r}
is.old_spct(another.old.spct)
upgrade_spectra()
is.old_spct(another.old.spct)
is.source_spct(another.old.spct)
```

We hope that these functions will make the transition to the new version
less painful. 


